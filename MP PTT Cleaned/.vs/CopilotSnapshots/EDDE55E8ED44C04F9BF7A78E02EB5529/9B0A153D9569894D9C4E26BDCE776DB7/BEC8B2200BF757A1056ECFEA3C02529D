using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows.Forms;

namespace MP_PTT
{
    public partial class AddExfilForm : Form
    {
        public string SelectedMapId { get; private set; }
        public string SelectedMapDisplayName { get; private set; }
        public string SelectedExfilIdentifier { get; private set; }
        public string SelectedExfilDescription { get; private set; }
        public List<string> SelectedInfiltrations { get; private set; }

        private ComboBox cmbMap;
        private ComboBox cmbExfilPoint;
        private TreeView treeInfiltrations;
        private Button btnOK;
        private Button btnCancel;
        private Label lblMap;
        private Label lblExfilPoint;
        private Label lblInfiltrations;
        private Label lblHelp;
        private Button btnExpandAll;
        private Button btnCollapseAll;

        public AddExfilForm()
        {
            InitializeComponent();
            LoadMaps();
        }

        private void InitializeComponent()
        {
            this.Text = "Add Exfiltration Point";
            this.Width = 600;
            this.Height = 550;
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.StartPosition = FormStartPosition.CenterParent;
            this.MaximizeBox = false;
            this.MinimizeBox = false;

            // Help label
            lblHelp = new Label
            {
                Text = "Select a map, then choose an exfiltration point, and finally select the infiltration(s) it leads to.",
                Location = new System.Drawing.Point(10, 10),
                Size = new System.Drawing.Size(560, 40),
                AutoSize = false
            };
            this.Controls.Add(lblHelp);

            // Map selection
            lblMap = new Label
            {
                Text = "1. Select Map:",
                Location = new System.Drawing.Point(10, 60),
                Size = new System.Drawing.Size(560, 20)
            };
            this.Controls.Add(lblMap);

            cmbMap = new ComboBox
            {
                Location = new System.Drawing.Point(10, 85),
                Size = new System.Drawing.Size(560, 25),
                DropDownStyle = ComboBoxStyle.DropDownList
            };
            cmbMap.SelectedIndexChanged += CmbMap_SelectedIndexChanged;
            this.Controls.Add(cmbMap);

            // Exfil point selection
            lblExfilPoint = new Label
            {
                Text = "2. Select Exfiltration Point:",
                Location = new System.Drawing.Point(10, 120),
                Size = new System.Drawing.Size(560, 20)
            };
            this.Controls.Add(lblExfilPoint);

            cmbExfilPoint = new ComboBox
            {
                Location = new System.Drawing.Point(10, 145),
                Size = new System.Drawing.Size(560, 25),
                DropDownStyle = ComboBoxStyle.DropDownList,
                Enabled = false
            };
            cmbExfilPoint.SelectedIndexChanged += CmbExfilPoint_SelectedIndexChanged;
            this.Controls.Add(cmbExfilPoint);

            // Infiltrations selection
            lblInfiltrations = new Label
            {
                Text = "3. Select Infiltration(s) this exfil leads to (organized by map):",
                Location = new System.Drawing.Point(10, 180),
                Size = new System.Drawing.Size(560, 20)
            };
            this.Controls.Add(lblInfiltrations);

            // TreeView for infiltrations
            treeInfiltrations = new TreeView
            {
                Location = new System.Drawing.Point(10, 205),
                Size = new System.Drawing.Size(560, 240),
                CheckBoxes = true,
                Enabled = false
            };
            treeInfiltrations.AfterCheck += TreeInfiltrations_AfterCheck;
            this.Controls.Add(treeInfiltrations);

            // Expand/Collapse buttons
            btnExpandAll = new Button
            {
                Text = "Expand All",
                Location = new System.Drawing.Point(10, 455),
                Size = new System.Drawing.Size(90, 25),
                Enabled = false
            };
            btnExpandAll.Click += (s, e) => treeInfiltrations.ExpandAll();
            this.Controls.Add(btnExpandAll);

            btnCollapseAll = new Button
            {
                Text = "Collapse All",
                Location = new System.Drawing.Point(110, 455),
                Size = new System.Drawing.Size(90, 25),
                Enabled = false
            };
            btnCollapseAll.Click += (s, e) => treeInfiltrations.CollapseAll();
            this.Controls.Add(btnCollapseAll);

            // OK/Cancel buttons
            btnOK = new Button
            {
                Text = "Add",
                Location = new System.Drawing.Point(400, 455),
                Size = new System.Drawing.Size(80, 30),
                DialogResult = DialogResult.OK,
                Enabled = false
            };
            this.Controls.Add(btnOK);

            btnCancel = new Button
            {
                Text = "Cancel",
                Location = new System.Drawing.Point(490, 455),
                Size = new System.Drawing.Size(80, 30),
                DialogResult = DialogResult.Cancel
            };
            this.Controls.Add(btnCancel);

            this.AcceptButton = btnOK;
            this.CancelButton = btnCancel;
        }

        private void LoadMaps()
        {
            cmbMap.Items.Clear();
            
            var allMaps = MapDataProvider.GetAllMaps();
            var sortedMaps = allMaps.Values.OrderBy(m => m.MapDisplayName).ToList();
            
            foreach (var map in sortedMaps)
            {
                cmbMap.Items.Add(new MapItem
                {
                    MapId = map.MapId,
                    MapDisplayName = map.MapDisplayName
                });
            }
            
            if (cmbMap.Items.Count > 0)
            {
                cmbMap.DisplayMember = "MapDisplayName";
            }
        }

        private void CmbMap_SelectedIndexChanged(object sender, EventArgs e)
        {
            var selectedMap = cmbMap.SelectedItem as MapItem;
            if (selectedMap == null)
                return;

            // Load exfil points for selected map
            cmbExfilPoint.Items.Clear();
            treeInfiltrations.Nodes.Clear();
            
            var mapData = MapDataProvider.GetMap(selectedMap.MapId);
            if (mapData != null)
            {
                var sortedExfils = mapData.Exfiltrations.OrderBy(exf => exf.Description).ToList();
                foreach (var exfil in sortedExfils)
                {
                    cmbExfilPoint.Items.Add(new ExfilItem
                    {
                        Identifier = exfil.Identifier,
                        Description = exfil.Description
                    });
                }
                
                if (cmbExfilPoint.Items.Count > 0)
                {
                    cmbExfilPoint.DisplayMember = "Description";
                    cmbExfilPoint.Enabled = true;
                }
            }
            
            btnOK.Enabled = false;
        }

        private void CmbExfilPoint_SelectedIndexChanged(object sender, EventArgs e)
        {
            var selectedExfil = cmbExfilPoint.SelectedItem as ExfilItem;
            if (selectedExfil == null)
                return;

            // Load infiltrations organized by map
            treeInfiltrations.Nodes.Clear();
            
            // Get all maps and their infiltrations
            var allMaps = MapDataProvider.GetAllMaps();
            
            // Group infiltrations by map
            foreach (var map in allMaps.Values.OrderBy(m => m.MapDisplayName))
            {
                if (map.Infiltrations.Count == 0)
                    continue;
                    
                var mapNode = new TreeNode(map.MapDisplayName)
                {
                    Tag = map.MapId
                };
                
                foreach (var infil in map.Infiltrations.OrderBy(i => i))
                {
                    var infilNode = new TreeNode(infil)
                    {
                        Tag = infil
                    };
                    mapNode.Nodes.Add(infilNode);
                }
                
                treeInfiltrations.Nodes.Add(mapNode);
            }
            
            treeInfiltrations.Enabled = true;
            btnExpandAll.Enabled = true;
            btnCollapseAll.Enabled = true;
            
            UpdateOKButton();
        }

        private void TreeInfiltrations_AfterCheck(object sender, TreeViewEventArgs e)
        {
            // Prevent checking parent nodes
            if (e.Node.Tag is string tag && tag.Length > 0 && e.Node.Nodes.Count > 0)
            {
                // This is a map node, uncheck it
                e.Node.Checked = false;
                return;
            }
            
            UpdateOKButton();
        }

        private void UpdateOKButton()
        {
            // Count checked infiltration nodes (not map nodes)
            int checkedCount = 0;
            foreach (TreeNode mapNode in treeInfiltrations.Nodes)
            {
                foreach (TreeNode infilNode in mapNode.Nodes)
                {
                    if (infilNode.Checked)
                        checkedCount++;
                }
            }
            
            btnOK.Enabled = checkedCount > 0;
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            base.OnFormClosing(e);
            
            if (this.DialogResult == DialogResult.OK)
            {
                var selectedMap = cmbMap.SelectedItem as MapItem;
                var selectedExfil = cmbExfilPoint.SelectedItem as ExfilItem;
                
                // Collect checked infiltrations
                var checkedInfils = new List<string>();
                foreach (TreeNode mapNode in treeInfiltrations.Nodes)
                {
                    foreach (TreeNode infilNode in mapNode.Nodes)
                    {
                        if (infilNode.Checked && infilNode.Tag is string infil)
                        {
                            checkedInfils.Add(infil);
                        }
                    }
                }
                
                if (selectedMap == null || selectedExfil == null || checkedInfils.Count == 0)
                {
                    MessageBox.Show("Please complete all selections.", "Incomplete Selection", 
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    e.Cancel = true;
                    return;
                }
                
                SelectedMapId = selectedMap.MapId;
                SelectedMapDisplayName = selectedMap.MapDisplayName;
                SelectedExfilIdentifier = selectedExfil.Identifier;
                SelectedExfilDescription = selectedExfil.Description;
                SelectedInfiltrations = checkedInfils;
            }
        }

        private class MapItem
        {
            public string MapId { get; set; }
            public string MapDisplayName { get; set; }
        }

        private class ExfilItem
        {
            public string Identifier { get; set; }
            public string Description { get; set; }
        }
    }
}
